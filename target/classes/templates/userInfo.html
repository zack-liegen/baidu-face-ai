<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style type="text/css">
        html,body{width: 100%;height: 100%;background: #F5F6F7}
        button {
            height: 40px;
            width: 60px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px 10px;
        }
        .confirmBtn {
            background-color: #356efd;
            color: #eeeeee;
            border : solid 1px #356efd;
        }
        /* 遮罩层 */
        #overlayFace {
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            font-size: 16px;
            /* IE9以下不支持rgba模式 */
            background-color: rgba(0, 0, 0, 0.5);
            /* 兼容IE8及以下 */
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr=#7f000000,endColorstr=#7f000000);
            display: none;
        }
        #overlayPassword {
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            font-size: 16px;
            /* IE9以下不支持rgba模式 */
            background-color: rgba(0, 0, 0, 0.5);
            /* 兼容IE8及以下 */
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr=#7f000000,endColorstr=#7f000000);
            display: none;
        }
        /* 弹出框主体 */
        .popup {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-content: center;
            background-color: #ffffff;
            width: 800px;
            height: 660px;
            border-radius: 8px;
            margin: 100px auto;
            text-align: center;
        }
        /* 弹出框的标题 */
        .popup_title {
            margin-top: -1px;
            height: 60px;
            line-height: 60px;
            border-bottom: solid 1px #cccccc;
            font-size: x-large;
        }
        /* 弹出框的内容 */
        .popup_content {
            height: 400px;
            padding: 15px 10px;
        }
        /* 弹出框的按钮栏 */
        .popup_btn {
            display: flex;
            justify-content: flex-end;
            width: 100%;
            padding-bottom: 10px;
        }
        /* 弹出框的按钮 */
        .popup_btn button {
            height: 40px;
            width: 60px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px 10px;
        }
        .cancelBtn {
            background-color: #ffffff;
            color: #111111;
            border : solid 1px #444444;
        }
        .confirmBtn {
            background-color: #356efd;
            color: #eeeeee;
            border : solid 1px #356efd;
        }
        .incorrect:before {
            /*叉*/
            content: '\2716';
            /*    勾*/
            /*    content: '\2714';*/
        }
    </style>
</head>
<body>
    <div style="display: flex; width: 100%;">
        <div id="menu" style="width: 200px"></div>
        <div style="
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px; margin-left: 60px;"
        >
            <div style="width: 350px; display: flex;">
                <div style="width: 120px; text-align: end;">
                    用户名：
                </div>
                <span id="userName" style="margin-left: 5px"></span>
            </div>
<!--            <div style="width: 350px; display: flex; margin-top: 30px">-->
<!--                <div style="width: 120px; text-align: end;">-->
<!--                    真实姓名：-->
<!--                </div>-->
<!--                <span id="realName" style="margin-left: 5px"></span>-->
<!--            </div>-->
<!--            <div style="width: 350px; display: flex; margin-top: 30px">-->
<!--                <div style="width: 120px; text-align: end;">-->
<!--                    联系电话：-->
<!--                </div>-->
<!--                <span id="telephone" style="margin-left: 5px"></span>-->
<!--            </div>-->
            <div style="width: 350px; display: flex; margin-top: 30px">
                <div style="width: 120px; text-align: end;">
                    人像照片：
                </div>
                <img style="width: 200px;" id="userPhoto" src="" alt="User Photo" />
            </div>
            <div style="width: 100%; display: flex; justify-content: center; margin-top: 35px">
                <button class="confirmBtn" onclick="showPopup2()" style="margin-right: 25px; width: 80px">修改人像</button>
                <button class="confirmBtn" onclick="showPopup()" style="margin-right: 25px;  width: 80px">修改密码</button>
            </div>
        </div>


    </div>
    <div id="overlayPassword">
        <div class="popup">
            <div style="display: flex; justify-content: space-between; width: 100%; height: 60px; background: #356EFD">
                <div></div>
                <p class="popup_title">修改密码</p>
                <span onclick="hidePopup()" class="status incorrect" style="margin-right: 10px; margin-top: 10px; cursor: pointer;"></span>
            </div>

            <div class="popup_content">
                <div class="media" style="display: flex; flex-direction: column; align-items: center; width: 100%">
                    <div style="display: flex; width: 35%; min-width: 250px; margin-top: -25px">
                        <div style=" min-width: 113px; width: 25%"> 旧密码： </div>
                        <input style="" type="text" name="oldPassword" id="oldPassword"/>
                    </div>
                    <div style="display: flex; width: 35%; min-width: 250px; margin-top: 10px">
                        <div style=" min-width: 113px; width: 25%"> 新密码： </div>
                        <input style="" type="text" name="newPassword" id="newPassword"/>
                    </div>
                    <div style="display: flex; width: 35%; min-width: 250px; margin-top: 10px">
                        <div style=" min-width: 113px; width: 25%"> 新密码： </div>
                        <input style="" type="text" name="newPasswordR" id="newPasswordR"/>
                    </div>
                    <video id="video" width="500" height="400" style="margin-top: 15px" src="" autoplay></video>
                    <!--画布不在页面显示-->
                    <canvas id="canvas" width="500" height="400" style=" display: none;" ></canvas>
                </div>
            </div>
            <div class="popup_btn">
                <button class="cancelBtn" onclick="hidePopup()">关闭</button>
                <button class="confirmBtn" onclick="goEdit()">确认</button>
            </div>
        </div>
    </div>
    <div id="overlayFace">
        <div class="popup">
            <div style="display: flex; justify-content: space-between; width: 100%; height: 60px; background: #356EFD">
                <div></div>
                <p class="popup_title">修改人像</p>
                <span onclick="hidePopup2()" class="status incorrect" style="margin-right: 10px; margin-top: 10px; cursor: pointer;"></span>
            </div>

            <div class="popup_content">
                <div class="media" style="display: flex; flex-direction: column; align-items: center; width: 100%">
                    <div style="display: flex; width: 35%; min-width: 250px; margin-top: 10px">
                        <div style=" min-width: 113px; width: 25%"> 请输入密码： </div>
                        <input style="" type="text" name="passwordFace" id="passwordFace"/>
                    </div>
                    <video id="videoFace" width="500" height="400" style="margin-top: 15px" src="" autoplay></video>
                    <!--画布不在页面显示-->
                    <canvas id="canvasFace" width="500" height="400" style=" display: none;" ></canvas>
                </div>
            </div>
            <div class="popup_btn">
                <button class="cancelBtn" onclick="hidePopup2()">关闭</button>
                <button class="confirmBtn" onclick="goFace()">确认</button>
            </div>
        </div>
    </div>

<div id="userInfo">
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    let userInfo ={
        userName: "admin"
    }
    let userContext = null;
    let userContextFace = null;
    document.getElementById('userName').innerText = userInfo.userName;
    // document.getElementById('realName').innerText = userInfo.userName;
    // document.getElementById('telephone').innerText = userInfo.userName;
    $("#menu").load("./menu");
    $.ajax({
        url: "/api/getUser",
        type: "get",
        data: {
            "userName": localStorage.getItem('user')
        },
        success: function(result){
            console.log('返回消息：', result);
            if(result.success){
                userInfo = result.result
                console.log(userInfo.userName)
                userInfo.faceBase = "data:image/png;base64," + userInfo.faceBase;
                document.getElementById('userPhoto').src = userInfo.faceBase;
            }
        }
    });
    function showPopup(){
        const overlayPassword = document.getElementById("overlayPassword");
        overlayPassword.style.display = "block";
        /**调用摄像头，获取媒体视频流**/
        var video = document.getElementById('video');
        //返回画布二维画图环境
        userContext = canvas.getContext("2d");
        var getUserMedia =
            //浏览器兼容,表示在火狐、Google、IE等浏览器都可正常支持
            (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia)
        //getUserMedia.call(要调用的对象，约束条件，调用成功的函数，调用失败的函数)
        getUserMedia.call(navigator,{video: true,audio: false},function(localMediaStream){
            //获取摄像头捕捉的视频流
            video.srcObject=localMediaStream;
        },function(e){
            console.log("获取摄像头失败！！")
        });
    }
    function hidePopup(){
        const overlayPassword = document.getElementById("overlayPassword");
        overlayPassword.style.display = "none";
    }
    function showPopup2(){
        const overlayFace = document.getElementById("overlayFace");
        overlayFace.style.display = "block";
        /**调用摄像头，获取媒体视频流**/
        var videoFace = document.getElementById('videoFace');
        //返回画布二维画图环境
        userContextFace = canvasFace.getContext("2d");
        var getUserMedia =
            //浏览器兼容,表示在火狐、Google、IE等浏览器都可正常支持
            (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia)
        //getUserMedia.call(要调用的对象，约束条件，调用成功的函数，调用失败的函数)
        getUserMedia.call(navigator,{video: true,audio: false},function(localMediaStream){
            //获取摄像头捕捉的视频流
            videoFace.srcObject=localMediaStream;
        },function(e){
            console.log("获取摄像头失败！！")
        });
    }
    function hidePopup2(){
        const overlayFace = document.getElementById("overlayFace");
        overlayFace.style.display = "none";
    }
    function goEdit(){
        let oldPassword = document.getElementById('oldPassword').value;
        let newPassword = document.getElementById('newPassword').value;
        let newPasswordR = document.getElementById('newPasswordR').value;
        if(oldPassword == "" || newPassword == "" || newPasswordR == ""){
            alert("请输入完整信息")
        }
        else if(newPassword != newPasswordR){
            alert("两次密码不一致")
        }
        else{
            userContext.drawImage(video,0,0,500,400);
            const userImgSrc = document.getElementById("canvas").toDataURL("img/png");
            //拿到bash64格式的照片信息
            const faceBase = userImgSrc.split(",")[1];

            $.ajax({
                url: "/api/changePassword",
                type: "post",
                data: {
                    "userName": localStorage.getItem('user'),
                    "oldPassword": hashStringToInt(oldPassword),
                    "newPassword": hashStringToInt(newPassword),
                    "faceBase": faceBase,
                },
                success: function(result){
                    console.log('返回消息：', result);
                    if(result.success){
                        alert("修改成功")
                        hidePopup()
                    }else{
                        alert(result.message)
                    }
                }
            })
        }
    }
    function goFace(){
        let passwordFace = document.getElementById('passwordFace').value;
        if(passwordFace == ""){
            alert("请输入密码")
        }
        else{
            userContextFace.drawImage(videoFace,0,0,500,400);
            const userImgSrc = document.getElementById("canvasFace").toDataURL("img/png");
            //拿到bash64格式的照片信息
            const faceBase = userImgSrc.split(",")[1];
            $.ajax({
                url: "/api/changeFace",
                type: "post",
                data: {
                    "userName": localStorage.getItem('user'),
                    "password": hashStringToInt(passwordFace),
                    "faceBase": faceBase,
                },
                success: function(result){
                    console.log('返回消息：', result);
                    if(result.success){
                        alert("修改成功")
                        hidePopup2()
                    }else{
                        alert(result.message)
                    }
                }
            })
        }
    }
    function hashStringToInt(str) {
        let hash = "";
        let firstCode = 13;
        for (let i = 0; i < str.length; i++) {
            let nowCode = str.charCodeAt(i);
            let code = (firstCode + nowCode)%255;
            firstCode = code;
            hash += code.toString(16);
        }
        return hash;
    }
</script>
</body>
</html>
